{% extends "base.html" %}

{% block title %}Map Results{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4"><i class="fas fa-dove me-2"></i>Map</h1>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">
                <i class="fas fa-filter me-2"></i>Projects
            </h5>
        </div>
        <div class="card-body">
            <label class="form-label" for="project">Project</label>
            <select id="project" class="form-select">
                <option value="">Choose project</option>
                {% for project in projects %}
                <option value="{{ project.id }}">{{ project.name }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6 col-sm-12">
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-map-marker-alt me-2"></i>Map
                    </h5>
                </div>
                <div class="card-body">
                    <div id="projmap" style="height: 400px;"></div>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-sm-12">
            <!-- Interactive Chart -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>Observed
                    </h5>
                </div>
                <div class="card-body">
                    <div id="speciesChart" style="height: 400px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="card">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-table me-2"></i>Observation Details
            </h5>
            <a href="{{ url_for('ajax.export_report') }}?sql={{ request.query_string.decode() }}&fmt=csv"
               class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-download me-1"></i> Export
            </a>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Site</th>
                            <th>Count</th>
                            <th>Supp Count</th>
                            <th>Total Count</th>
                        </tr>
                    </thead>
                    <tbody>
                     <!--To be filled in when marker clicked -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.2/plotly.min.js"></script>

<!-- Chart Initialization -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const chartData = {data: [], layout: {}}; // Turn this into a handler for marker click event

        Plotly.newPlot('speciesChart', chartData.data, chartData.layout, {
            responsive: true,
            displayModeBar: true
        });

        // Make chart responsive
        window.addEventListener('resize', function() {
            Plotly.Plots.resize('speciesChart');
        });
    });

    // Initialize the map
    const map = L.map('projmap').setView([40.505, -80.09], 9);

    // Add OpenStreetMap tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Each project is a separate layer
    const projectSelect = document.getElementById('project');
    const layerGroups = {};

    document.addEventListener('DOMContentLoaded', function() {
        projectSelect.addEventListener('change', () => {
            const projId = projectSelect.value;
            fetch('/ajax/get_proj_sites/' + projId)
                .then(response => response.json())
                .then(data => displayProjectLayer(projectSelect.textContent, data));
        });
    });

    const displayProjectLayer = (name, data) => {
        // Clear existing layers
        Object.keys(layerGroups).forEach((layerName) => {
            map.removeLayer(layerGroups[layerName]);
        });

        // Add new layer for this project
        const layerName = name;
        const layer = L.layerGroup();
        layerGroups[layerName] = layer;

        // Create a line for each site
        data.forEach((siteData) => {
            const linePoints = siteData.points.map(pt =>
            {
                [pt.lat, pt.lng];
                L.marker(pt, {icon: createIcon('#f00')}).addTo(layer);
            });
            const siteline = L.polyline(linePoints, {color: '#f0f'}).addTo(layer);

            siteline.bindPopup(`<b>${siteData.name}</b><br>${siteData.description}`);
            layer.addLayer(siteline);
        });

        layer.addTo(map);
    }

    // Custom marker icons
    function createIcon(color) {
        return L.divIcon({
            className: 'custom-marker',
            html: `<svg width="24" height="36" viewBox="0 0 24 36" xmlns="http://www.w3.org/2000/svg">
                    <path fill="${color}" d="M12 0C5.4 0 0 5.4 0 12c0 7.2 12 24 12 24s12-16.8 12-24c0-6.6-5.4-12-12-12z"/>
                    <circle fill="white" cx="12" cy="12" r="5"/>
                  </svg>`,
            iconSize: [24, 36],
            iconAnchor: [12, 36],
            popupAnchor: [0, -36]
        });
    }
</script>
{% endblock %}