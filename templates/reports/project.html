{% extends "base.html" %}

{% block title %}Project Results{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">
        <i class="fas fa-dove me-2"></i>Project Results
    </h1>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">
                <i class="fas fa-filter me-2"></i>Report Filters
            </h5>
        </div>
        <div class="card-body">
            <form method="POST" class="row g-3">
                {{ form.hidden_tag() }}
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label" for="project">Project</label>
                        {{ form.project(class="form-control", id="project") }}
                        {{ form.date_start.label(class="form-label") }}
                    </div>
                    <div class="col-md-6 mb-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary me-2">
                            <i class="fas fa-search me-1"></i> Report
                        </button>
                        <a href="{{ url_for('report.project_report') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-sync-alt me-1"></i> Reset
                        </a>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="input-group">
                            {{ form.date_start(class="form-control datepicker" + (" is-invalid" if form.date_start.errors else "")) }}
                            <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                        </div>
                        {{ form.date_end.label(class="form-label") }}
                        <div class="input-group">
                            {{ form.date_end(class="form-control datepicker" + (" is-invalid" if form.date_end.errors else "")) }}
                            <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <!-- Summary Cards -->
                        <div class="card text-white bg-success">
                            <div class="card-body m-2">
                                <h5>Total Surveys: {{ surveys|length }}</h5>
                            </div>
                        </div>
                        <div class="card text-white bg-info">
                            <div class="card-body m-2">
                                <h5>Total Observations: {{ observations|length }}</h5>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>



    <!-- Interactive Chart -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">
                <i class="fas fa-chart-line me-2"></i>Species Distribution
            </h5>
        </div>
        <div class="card-body">
            <div id="speciesChart" style="height: 400px;"></div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="card">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-table me-2"></i>Observation Details
            </h5>
            <a href="{{ url_for('ajax.export_report') }}?sql={{ request.query_string.decode() }}&fmt=csv"
               class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-download me-1"></i> Export
            </a>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Species</th>
                            <th>Total Count</th>
                            <th>Sites</th>
                            <th>First Seen</th>
                            <th>Last Seen</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for species in species_data %}
                        <tr>
                            <td>
                                <strong>{{ species.name }}</strong>
                                {% if species.is_rare %}
                                <span class="badge bg-warning ms-2">Rare</span>
                                {% endif %}
                            </td>
                            <td>{{ species.total_count }}</td>
                            <td>
                                {% for loc in species.sites %}
                                <span class="badge bg-secondary me-1">{{ loc }}</span>
                                {% endfor %}
                            </td>
                            <td>{{ species.first_seen }}</td>
                            <td>{{ species.last_seen }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Charting Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.2/plotly.min.js"></script>

<!-- Chart Initialization -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chartData = JSON.parse('{{ chart_data | tojson | safe }}');

    Plotly.newPlot('speciesChart', chartData.data, chartData.layout, {
        responsive: true,
        displayModeBar: true
    });

    // Make chart responsive
    window.addEventListener('resize', function() {
        Plotly.Plots.resize('speciesChart');
    });
});
</script>
{% endblock %}